---
title: "JACUSA2helper Figure 1E"
author: "Christoph Dieterich, Michael Piechotta"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: JACUSA2helper-figure1e.bib
link-citations: yes
vignette: >
  %\VignetteIndexEntry{JACUSA2helper Figure 1E}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(tibble.print_min = 4L, tibble.print_max = 4L)
library(JACUSA2helper)
library(dplyr);
library(reshape2)
library(ggplot2)

set.seed(777)
```
See `vignette("JACUSA2helper")` for general description of analysis with JACUSA2helper.
For details on JACUSA2, check the [JACUSA2 manual](https://github.com/dieterich-lab/JACUSA2/blob/master/manual/manual.pdf).

In the following, the use of of the rt-arrest function will be applied to a MazF digestion assay from @Zhang2019.
Herein, 3 replicates of HEK293 mRNA were treated with FTO or mock treated and then subjected to a MazF digestion assay.

## Pre-filter MazF data

JACUSA2helper directly reads in output from JACUSA2 via the `read_result` function. As a next step we apply filters on the p_value, read coverage and select for only robust events.
This means that only sites are called where an arrest event is visible across all replicates for at least one condition.

```{r}
# MazF results
data(MazF)
filtered <- MazF %>% 
  dplyr::filter(pvalue <= 0.05) %>% 
  dplyr::filter(All(cov$cond1 >= 10) & All(cov$cond2 >= 10)) %>% 
  dplyr::filter(robust(arrest))
```

## Read and merge sequence motif information at cleavage site

The data structure is modified such that the presence or absence of the canonical clevage side motif is added (see also Figure 1D in manuscript).

```{r}
data(ACA)
vecACA <- ACA$motif
names(vecACA) <- ACA$coord
vecACA <- ifelse(vecACA == "ACA", "yes", "no")
filtered$ACA <- vecACA[filtered$id]
filtered <- filtered %>% 
  dplyr::filter(ACA %in% c("yes","no"))
```

## Scatter plot of arrest rates for replicate 1

Arrest rates are plotted depending on the presence or absence of an ACA motif. 

```{r}
filtered %>%
  ggplot2::ggplot(ggplot2::aes(x = arrest_rate$cond1$rep1, y = arrest_rate$cond2$rep1, color = ACA)) +  
  ggplot2::geom_point() + 
  ggplot2::geom_abline(colour = "red") +
  ggplot2::xlab("MazF+ and FTO- read arrest") + 
  ggplot2::ylab("MazF+ and FTO+ read arrest")
```
## Box plot of arrest rates over all replicates

Arrest rates are plotted depending on the presence or absence of an ACA motif. 

```{r}
toplot <- melt(as.matrix(filtered$arrest_rate))
toplot$ACA <- rep(filtered$ACA, 6)
colnames(toplot) <- c("Id", "sample", "arrest_rate", "ACA")

toplot$sample <- gsub("cond1", "MazF_mock", toplot$sample)
toplot$sample <- gsub("cond2", "MazF_FTO", toplot$sample)

ggplot2::ggplot(toplot, ggplot2::aes(x = sample, y = arrest_rate, color=ACA)) +
  ggplot2::geom_boxplot() 
```
